import{d as u,w as o}from"./DN0K50FJ.js";const f=1e3,g=2e3,i=o(!1),l=o(null),a=o([]),y=o(0),S=o(null),b=o(null),r=o([]),p=o([]),C=u(a,e=>e.length>0?e[e.length-1]:null);u(a,e=>e.filter(t=>t.tick_type==="output"));u(r,e=>e.length);let n=null,s=null;function k(e="ws://localhost:8000/ws/bed/default"){if(n&&n.readyState===WebSocket.OPEN){console.log("Already connected");return}console.log(`Connecting to BED at ${e}...`),l.set(null);try{n=new WebSocket(e),n.onopen=()=>{console.log("BED WebSocket connected"),i.set(!0),l.set(null),d({type:"get_status"}),d({type:"get_introspection"})},n.onmessage=t=>{try{const c=JSON.parse(t.data);_(c)}catch(c){console.error("Failed to parse WebSocket message:",c)}},n.onclose=t=>{console.log("BED WebSocket closed:",t.code,t.reason),i.set(!1),n=null,t.wasClean||h(e)},n.onerror=t=>{console.error("BED WebSocket error:",t),l.set("Connection failed")}}catch(t){console.error("Failed to create WebSocket:",t),l.set(`Failed to connect: ${t}`),h(e)}}function D(){s&&(clearTimeout(s),s=null),n&&(n.close(1e3,"Client disconnect"),n=null),i.set(!1)}function h(e){s||(console.log(`Scheduling reconnect in ${g}ms...`),s=setTimeout(()=>{s=null,k(e)},g))}function d(e){n&&n.readyState===WebSocket.OPEN&&n.send(JSON.stringify(e))}function _(e){switch(e.type){case"tick":E(e.payload);break;case"status":S.set(e.payload);break;case"introspection":b.set(e.payload);break;case"violation":w(e.payload);break;case"steering":T(e.payload);break;case"error":console.error("BED error:",e.payload),l.set(String(e.payload));break;default:console.warn("Unknown message type:",e.type)}}function E(e){a.update(t=>{const c=[...t,e];return c.length>f?c.slice(-f):c}),y.set(e.tick_id),e.hush_violations.length>0&&r.update(t=>[...t.slice(-19),...e.hush_violations]),e.steering_applied.length>0&&p.update(t=>[...t.slice(-19),...e.steering_applied])}function w(e){r.update(t=>[...t.slice(-19),e])}function T(e){p.update(t=>[...t.slice(-19),e])}function N(){d({type:"get_introspection"})}function O(){a.set([]),y.set(0)}function B(){r.set([]),p.set([])}export{i as a,S as b,k as c,D as d,l as e,O as f,r as g,p as h,b as i,B as j,C as l,N as r,a as t};
