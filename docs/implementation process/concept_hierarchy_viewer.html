<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HatCat Concept Hierarchy - Sunburst Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
        }

        #container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }

        #chart {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        #info-panel {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #444;
        }

        #breadcrumb {
            background: #333;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #4CAF50;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px;
            background: #333;
            border-radius: 4px;
        }

        .info-label {
            font-weight: bold;
            color: #aaa;
        }

        .info-value {
            color: #fff;
        }

        .layer-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #666;
        }

        svg text {
            pointer-events: none;
            fill: #fff;
            font-size: 11px;
        }

        path {
            stroke: #1a1a1a;
            stroke-width: 1px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        path:hover {
            opacity: 0.8;
        }

        #controls {
            text-align: center;
            margin: 20px 0;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>HatCat Concept Hierarchy</h1>
        <p class="subtitle">Interactive Sunburst Visualization | 7 Layers | 121,561 Total Concepts</p>

        <div class="layer-legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c;"></div>
                <span>Layer 0 (14 concepts)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e67e22;"></div>
                <span>Layer 1 (276 concepts)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f39c12;"></div>
                <span>Layer 2 (1,059 concepts)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #2ecc71;"></div>
                <span>Layer 3 (991 concepts)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #3498db;"></div>
                <span>Layer 4 (3,221 concepts)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9b59b6;"></div>
                <span>Layer 5 (21 concepts)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #34495e;"></div>
                <span>Layer 6 (115,930 synsets - sampled)</span>
            </div>
        </div>

        <div id="controls">
            <button id="reset-btn">Reset View</button>
            <button id="zoom-out-btn" disabled>Zoom Out</button>
        </div>

        <div id="chart"></div>

        <div id="info-panel">
            <div id="breadcrumb">Click on any segment to explore the hierarchy</div>
            <div id="details"></div>
        </div>
    </div>

    <script>
        // Configuration
        const width = 900;
        const height = 900;
        const radius = Math.min(width, height) / 2;

        // Color scale for layers
        const layerColors = {
            0: '#e74c3c',
            1: '#e67e22',
            2: '#f39c12',
            3: '#2ecc71',
            4: '#3498db',
            5: '#9b59b6',
            6: '#34495e'
        };

        // Create SVG
        const svg = d3.select('#chart')
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .append('g')
            .attr('transform', `translate(${width / 2},${height / 2})`);

        // Create partition layout
        const partition = d3.partition()
            .size([2 * Math.PI, radius]);

        // Create arc generator
        const arc = d3.arc()
            .startAngle(d => d.x0)
            .endAngle(d => d.x1)
            .innerRadius(d => d.y0)
            .outerRadius(d => d.y1);

        // Track current focus
        let focusNode = null;
        let zoomStack = [];

        // Load data and render
        d3.json('concept_hierarchy_sunburst.json').then(data => {
            console.log("Data loaded:", data);
            if (!data || !data.children) {
                console.error("No data or children found!");
                document.getElementById('breadcrumb').innerHTML = '<strong style="color:red">ERROR: Data failed to load</strong>';
                return;
            }
            // Create hierarchy
            const root = d3.hierarchy(data)
                .sum(d => d.value || 1)
                .sort((a, b) => b.value - a.value);

            // Apply partition
            partition(root);

            // Initial focus is root
            focusNode = root;

            // Draw arcs
            const paths = svg.selectAll('path')
                .data(root.descendants())
                .join('path')
                .attr('d', arc)
                .attr('fill', d => layerColors[d.data.layer] || '#555')
                .attr('opacity', 0.9)
                .on('click', clicked)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('opacity', 1);
                    showInfo(d);
                })
                .on('mouseout', function(event, d) {
                    d3.select(this).attr('opacity', 0.9);
                });

            // Add labels for larger segments
            svg.selectAll('text')
                .data(root.descendants().filter(d => d.x1 - d.x0 > 0.05))
                .join('text')
                .attr('transform', d => {
                    const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
                    const y = (d.y0 + d.y1) / 2;
                    return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
                })
                .attr('dy', '0.35em')
                .attr('text-anchor', 'middle')
                .attr('font-size', d => Math.min(10, (d.y1 - d.y0) * 0.8))
                .text(d => {
                    const name = d.data.name;
                    if (name.length > 15) return name.substring(0, 12) + '...';
                    return name;
                });

            // Show root info
            showInfo(root);
            console.log("Visualization rendered successfully with", root.descendants().length, "nodes");

            // Click handler
            function clicked(event, p) {
                zoomStack.push(focusNode);
                focusNode = p;
                updateZoomButtons();

                // Zoom animation
                root.each(d => d.target = {
                    x0: Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
                    x1: Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
                    y0: Math.max(0, d.y0 - p.y0),
                    y1: Math.max(0, d.y1 - p.y0)
                });

                const t = svg.transition().duration(750);

                paths.transition(t)
                    .tween('data', d => {
                        const i = d3.interpolate(d.current, d.target);
                        return t => d.current = i(t);
                    })
                    .attrTween('d', d => () => arc(d.current));

                showInfo(p);
            }

            // Initial current values
            root.each(d => d.current = {
                x0: d.x0,
                x1: d.x1,
                y0: d.y0,
                y1: d.y1
            });
        }).catch(error => {
            console.error("Failed to load data:", error);
            document.getElementById('breadcrumb').innerHTML = `<strong style="color:red">ERROR: ${error.message}</strong><br>Try running: <code>cd docs && python3 -m http.server 8888</code><br>Then open: <code>http://localhost:8888/concept_hierarchy_viewer.html</code>`;
        });

        // Show info panel
        function showInfo(d) {
            const breadcrumb = getBreadcrumb(d);
            document.getElementById('breadcrumb').innerHTML = `
                <strong>Path:</strong> ${breadcrumb.join(' â†’ ')}
            `;

            const childCount = d.children ? d.children.length : 0;
            const leafCount = d.leaves ? d.leaves().length : 0;

            document.getElementById('details').innerHTML = `
                <div class="info-row">
                    <span class="info-label">Concept:</span>
                    <span class="info-value">${d.data.name}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Layer:</span>
                    <span class="info-value">${d.data.layer}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Direct Children:</span>
                    <span class="info-value">${childCount}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Total Descendants:</span>
                    <span class="info-value">${leafCount}</span>
                </div>
            `;
        }

        // Get breadcrumb path
        function getBreadcrumb(d) {
            const path = [];
            let current = d;
            while (current) {
                path.unshift(current.data.name);
                current = current.parent;
            }
            return path;
        }

        // Update zoom buttons
        function updateZoomButtons() {
            document.getElementById('zoom-out-btn').disabled = zoomStack.length === 0;
        }

        // Reset button
        document.getElementById('reset-btn').addEventListener('click', () => {
            location.reload();
        });

        // Zoom out button
        document.getElementById('zoom-out-btn').addEventListener('click', () => {
            if (zoomStack.length > 0) {
                const prev = zoomStack.pop();
                // Trigger click on previous node
                const event = new MouseEvent('click');
                clicked(event, prev);
            }
        });
    </script>
</body>
</html>
